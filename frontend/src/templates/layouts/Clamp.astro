---
import type { ComponentProps } from "astro/types";
import Melt from "./Melt.astro";
import { clsx as mergeCSSClasses } from "clsx";
import _ from "lodash";

type CSSLengthUnit =
    | `px`
    | `em`
    | `rem`
    | `%`
    | `vw`
    | `vh`
    | `vmin`
    | `vmax`
    | `ch`
    | `ex`
    | `pt`
    | `pc`
    | `in`
    | `cm`
    | `mm`;

type CSSLengthKeyword =
    | "auto"
    | "fit-content"
    | "max-content"
    | "min-content"
    | "inherit"
    | "initial"
    | "unset";

type Length = number | `${number}${CSSLengthUnit}` | CSSLengthKeyword;
type LengthVar = Length | [Length, Length] | [Length, Length, Length];

export interface Props
    extends Astro.ComponentProps,
        ComponentProps<typeof Melt> {
    width?: LengthVar;
    height?: LengthVar;
}

const { width, height, class: className, style, ...props } = Astro.props;

function resolveLengthVars(lengthVar?: LengthVar): {
    min?: Length;
    base?: Length;
    max?: Length;
} {
    if (_.isEmpty(lengthVar)) return {};
    if (!_.isArray(lengthVar)) return { base: lengthVar };

    switch (lengthVar.length) {
        case 2:
            return { min: lengthVar.at(0), max: lengthVar.at(1) };
        case 3:
            return {
                min: lengthVar.at(0),
                base: lengthVar.at(1),
                max: lengthVar.at(2),
            };
        default:
            return {};
    }
}
function normalizeLength(value: Length | undefined) {
    return _.isNumber(value) ? `${value}px` : value;
}

const {
    min: minWidth,
    base: baseWidth,
    max: maxWidth,
} = resolveLengthVars(width);
const {
    min: minHeight,
    base: baseHeight,
    max: maxHeight,
} = resolveLengthVars(height);

const combinedClass = mergeCSSClasses(className, {
    "min-w-(--min-width)": minWidth,
    "w-(--base-width)": baseWidth,
    "max-w-(--max-width)": maxWidth,
    "min-h-(--min-height]": minHeight,
    "w-(--base-height)": baseHeight,
    "max-w-(--max-height)": maxHeight,
});

const combinedStyle = mergeCSSClasses(
    style,
    _.map(
        _.pickBy({
            "min-width": minWidth,
            "base-width": baseWidth,
            "max-width": maxWidth,
            "min-height": minHeight,
            "base-height": baseHeight,
            "max-height": maxHeight,
        }),
        (value, key) => `--${key}: ${normalizeLength(value as any)};`,
    ).join(""),
);
---

<Melt {...{ ...props, class: combinedClass, style: combinedStyle }}>
    <slot />
</Melt>
