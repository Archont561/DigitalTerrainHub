---
import { Window, type Element as HappyElement } from "happy-dom";
import _ from "lodash";

const parser = new new Window().DOMParser();

export interface Props {
    melt?: boolean;
}

const { melt, ...attributes } = Astro.props;

const setAttributes = (
    element: HappyElement,
    attrs: Record<string, unknown>,
) => {
    _.forEach(attrs, (value, key) => {
        element.setAttribute(key, value as any);
    });
};

const htmlToMelt = await Astro.slots.render("default");
const document = parser.parseFromString(htmlToMelt, "text/html");

let html = "";
if (melt) {
    const firstElem = document.body.firstElementChild;
    firstElem && setAttributes(firstElem, attributes);
    html = document.body.innerHTML;
} else {
    const wrapper = document.createElement("div");
    _.forEach(document.body.children, (child) => {
        child && wrapper.appendChild(child.cloneNode(true));
    });
    setAttributes(wrapper, attributes);
    html = wrapper.outerHTML;
}
---

<Fragment set:html={html} />
