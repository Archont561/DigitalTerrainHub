---
import { Window, type Element as HappyElement } from "happy-dom";

const parser = new new Window().DOMParser();

export interface Props {
    melt?: boolean;
}

const { melt, ...attributes } = Astro.props;

const document = parser.parseFromString(
    await Astro.slots.render("default"),
    "text/html"
);

const setAttributes = (element: HappyElement, attrs: Record<string, unknown>) => {
    Object.entries(attrs).forEach(([key, value]) => {
        element.setAttribute(key, value as any);
    });
};

let html = "";
if (melt) {
    const firstElem = document.body.firstElementChild;
    firstElem && setAttributes(firstElem, attributes);
    html = document.body.innerHTML;
} else {
    const wrapper = document.createElement("div");
    [...document.body.children].forEach(child => wrapper.appendChild(child));
    setAttributes(wrapper, attributes);
    html = wrapper.outerHTML;
}
---

<Fragment set:html={html} />